---
layout: post
title: 'Adventures in Freebernetes: bhyve My Guest'
date: 2020-10-29 20:51:16.000000000 -07:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- FreeBSD Virtualization
tags:
- freebsd
- virtualization
meta:
  _oembed_1c572d25e82e2a67ddbc14a219420ec4: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="550" data-dnt="true"><p lang="en" dir="ltr">TIL
    MacOS&#39;s HyperKit is built on xhyve, a port of FreeBSD bhyve. Which doesn&#39;t
    surprise me, but cool.<br><br>You can run Docker on your Mac thanks to FreeBSD.
    Of course, you can run your Mac thanks to FreeBSD, too.</p>&mdash; Karen Bruner
    (@fuzzyKB) <a href="https://twitter.com/fuzzyKB/status/1320831517497511936?ref_src=twsrc%5Etfw">October
    26, 2020</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_1c572d25e82e2a67ddbc14a219420ec4: '1607027060'
  _last_editor_used_jetpack: block-editor
  _oembed_fd6469378c768c802cadd9acd9d221ec: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="550" data-dnt="true"><p lang="en" dir="ltr">Oh,
    since when did root&#39;s shell default to csh on FreeBSD?<br><br>(For all I know,
    it&#39;s been &quot;forever,&quot; but I forgot. But wondering why my patently-Bourne
    shell multi-file handle redirection wasn&#39;t working was making me nuts, until
    I finally thought to check...)</p>&mdash; Karen Bruner (@fuzzyKB) <a href="https://twitter.com/fuzzyKB/status/1321867141587570695?ref_src=twsrc%5Etfw">October
    29, 2020</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_fd6469378c768c802cadd9acd9d221ec: '1607027064'
  timeline_notification: '1604004682'
  _oembed_857eb9f7e3dcf9480e8420e1ebb45db4: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="550" data-dnt="true"><p lang="en" dir="ltr">TIL
    MacOS&#39;s HyperKit is built on xhyve, a port of FreeBSD bhyve. Which doesn&#39;t
    surprise me, but cool.<br><br>You can run Docker on your Mac thanks to FreeBSD.
    Of course, you can run your Mac thanks to FreeBSD, too.</p>&mdash; Karen Bruner
    (@fuzzyKB) <a href="https://twitter.com/fuzzyKB/status/1320831517497511936?ref_src=twsrc%5Etfw">October
    26, 2020</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_857eb9f7e3dcf9480e8420e1ebb45db4: '1604004684'
  _oembed_65ed6879e2d6d4be64570daf34a59619: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="550" data-dnt="true"><p lang="en" dir="ltr">Oh,
    since when did root&#39;s shell default to csh on FreeBSD?<br><br>(For all I know,
    it&#39;s been &quot;forever,&quot; but I forgot. But wondering why my patently-Bourne
    shell multi-file handle redirection wasn&#39;t working was making me nuts, until
    I finally thought to check...)</p>&mdash; Karen Bruner (@fuzzyKB) <a href="https://twitter.com/fuzzyKB/status/1321867141587570695?ref_src=twsrc%5Etfw">October
    29, 2020</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_65ed6879e2d6d4be64570daf34a59619: '1604004684'
  _oembed_cdca5667ce80cd88ffb369a581755ba8: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="550" data-dnt="true"><p lang="en" dir="ltr">TIL
    MacOS&#39;s HyperKit is built on xhyve, a port of FreeBSD bhyve. Which doesn&#39;t
    surprise me, but cool.<br><br>You can run Docker on your Mac thanks to FreeBSD.
    Of course, you can run your Mac thanks to FreeBSD, too.</p>&mdash; Karen Bruner
    (@fuzzyKB) <a href="https://twitter.com/fuzzyKB/status/1320831517497511936?ref_src=twsrc%5Etfw">October
    26, 2020</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_cdca5667ce80cd88ffb369a581755ba8: '1604004685'
  _oembed_f3004d54d535477e4ad845f0568c09b8: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="550" data-dnt="true"><p lang="en" dir="ltr">Oh,
    since when did root&#39;s shell default to csh on FreeBSD?<br><br>(For all I know,
    it&#39;s been &quot;forever,&quot; but I forgot. But wondering why my patently-Bourne
    shell multi-file handle redirection wasn&#39;t working was making me nuts, until
    I finally thought to check...)</p>&mdash; Karen Bruner (@fuzzyKB) <a href="https://twitter.com/fuzzyKB/status/1321867141587570695?ref_src=twsrc%5Etfw">October
    29, 2020</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_f3004d54d535477e4ad845f0568c09b8: '1604004685'
  _publicize_job_id: '50480785334'
  _oembed_54a7608075f91a9d0e8570f9bf4161e4: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="500" data-dnt="true"><p lang="en" dir="ltr">TIL
    MacOS&#39;s HyperKit is built on xhyve, a port of FreeBSD bhyve. Which doesn&#39;t
    surprise me, but cool.<br><br>You can run Docker on your Mac thanks to FreeBSD.
    Of course, you can run your Mac thanks to FreeBSD, too.</p>&mdash; Karen Bruner
    (@fuzzyKB) <a href="https://twitter.com/fuzzyKB/status/1320831517497511936?ref_src=twsrc%5Etfw">October
    26, 2020</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_54a7608075f91a9d0e8570f9bf4161e4: '1604004994'
  _oembed_5d23ab16c9ecf96fe457b1235f8fcd8e: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="500" data-dnt="true"><p lang="en" dir="ltr">Oh,
    since when did root&#39;s shell default to csh on FreeBSD?<br><br>(For all I know,
    it&#39;s been &quot;forever,&quot; but I forgot. But wondering why my patently-Bourne
    shell multi-file handle redirection wasn&#39;t working was making me nuts, until
    I finally thought to check...)</p>&mdash; Karen Bruner (@fuzzyKB) <a href="https://twitter.com/fuzzyKB/status/1321867141587570695?ref_src=twsrc%5Etfw">October
    29, 2020</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_5d23ab16c9ecf96fe457b1235f8fcd8e: '1604004994'
  _oembed_2b142712f70f30d3e1fd066a7e16abd9: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="500" data-dnt="true"><p lang="en" dir="ltr">Day
    2 of Operation Free BSD<br><br>I updated the BIOS last night. Now trying to see
    I can manually boot from the ZFS-on-root partition, except Ziggy and George are
    having their 11AM zoomies so I keep getting distracted and miss the menu to exit
    into the boot loader.</p>&mdash; Karen Bruner (@fuzzyKB) <a href="https://twitter.com/fuzzyKB/status/1320067211864621058?ref_src=twsrc%5Etfw">October
    24, 2020</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_25c053be4999554489f1d4236c688c0b: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="500" data-dnt="true"><p lang="en" dir="ltr">Ok,
    I got the FreeBSD 13.0-CURRENT memstick image, used my ancient Linux laptop to
    dd it onto the USB drive.<br><br>My only HDMI display is my TV, sooooo I&#39;m
    currently sitting on the floor in front of it (don&#39;t have an HDMI cable +
    USB elongator for the keyboard to reach the couch).</p>&mdash; Karen Bruner (@fuzzyKB)
    <a href="https://twitter.com/fuzzyKB/status/1319742463527940097?ref_src=twsrc%5Etfw">October
    23, 2020</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_efe4c01f982cce35c60d9791a8f8882b: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="500" data-dnt="true"><p lang="en" dir="ltr">Woohoo!
    Success! Booting from the ZFS root with no human intervention! <a href="https://t.co/Glj4WaJiHn">pic.twitter.com/Glj4WaJiHn</a></p>&mdash;
    Karen Bruner (@fuzzyKB) <a href="https://twitter.com/fuzzyKB/status/1320104084183994368?ref_src=twsrc%5Etfw">October
    24, 2020</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_2b142712f70f30d3e1fd066a7e16abd9: '1604101759'
  _oembed_99d285230217198fe6e2dbb189e6d684: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="500" data-dnt="true"><p lang="en" dir="ltr">That&#39;s
    not good. <a href="https://t.co/HmX92ta1SI">pic.twitter.com/HmX92ta1SI</a></p>&mdash;
    Karen Bruner (@fuzzyKB) <a href="https://twitter.com/fuzzyKB/status/1320096641840394241?ref_src=twsrc%5Etfw">October
    24, 2020</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_25c053be4999554489f1d4236c688c0b: '1604101759'
  _oembed_time_efe4c01f982cce35c60d9791a8f8882b: '1604101759'
  _oembed_time_99d285230217198fe6e2dbb189e6d684: '1604101759'
  _oembed_bae6c6efe3e53cc7fb576da3c8d438d8: "<div class=\"embed-twitter\"><blockquote
    class=\"twitter-tweet\" data-width=\"500\" data-dnt=\"true\"><p lang=\"en\" dir=\"ltr\">I
    MISSED YOU SOOOO MUCH, FREEBSD CORE FILES!!!! ❤️\U0001F525 <a href=\"https://t.co/ORmzIRqrLi\">pic.twitter.com/ORmzIRqrLi</a></p>&mdash;
    Karen Bruner (@fuzzyKB) <a href=\"https://twitter.com/fuzzyKB/status/1322348545064644608?ref_src=twsrc%5Etfw\">October
    31, 2020</a></blockquote><script async src=\"https://platform.twitter.com/widgets.js\"
    charset=\"utf-8\"></script></div>"
  _oembed_time_bae6c6efe3e53cc7fb576da3c8d438d8: '1604107698'
  _oembed_d0748b0d3a89a24c9a6cfa5721aeee44: "{{unknown}}"
  _oembed_19ab63520ba984b4dc1f4edbc1a8c060: "{{unknown}}"
  _oembed_58f80a404ad7065d362c6cfc43796267: "{{unknown}}"
  _oembed_a55d5f53d4283e973a04695847059e45: "{{unknown}}"
  _oembed_13e706081b601f21ca0a03d65254f425: "{{unknown}}"
  _oembed_5142461d55cb9b3d621ded46ddd18d4e: "{{unknown}}"
  _oembed_305c5dd02372153cb636dcb32bc375f5: "{{unknown}}"
  _edit_last: '108235749'
  _oembed_4a9892f3845b21d2866d4f19672cbdd5: "{{unknown}}"
  _oembed_728a7e52091094449eca4dc6a28d6453: "{{unknown}}"
  _oembed_1e7f8b384b92a442a7f7f75352952b08: "{{unknown}}"
author:
  login: nightmarebeforedevops
  email: kbcontactxyz@gmail.com
  display_name: karenb
  first_name: Karen
  last_name: Bruner
permalink: "/2020/10/29/adventures-in-freebernetes-bhyve-my-guest/"
excerpt: 'Part 2 of experiments in FreeBSD and Kubernetes: Creating your first guest'
---
<!-- wp:paragraph {"fontSize":"medium"} -->

_Part 2 of experiments in FreeBSD and Kubernetes: Creating your first guest_

<!-- /wp:paragraph -->

<!-- wp:paragraph -->

[_See all posts in this series_](https://productionwithscissors.run/freebsd-virtualization-series/)

<!-- /wp:paragraph -->

<!-- wp:heading -->

## bhyve Background

<!-- /wp:heading -->

<!-- wp:paragraph -->

[bhyve](https://wiki.freebsd.org/bhyve) (pronounced as "beehive"), FreeBSD's type 2 (software) virtualization hypervisor, is pretty cool. It supports a number of operating systems as guest virtual machines (VMs), including not only the \*BSD family, but also Linux, Illumos, and even Windows NT.

<!-- /wp:paragraph -->

<!-- wp:embed {"url":"https:\/\/twitter.com\/fuzzyKB\/status\/1320831517497511936","type":"rich","providerNameSlug":"twitter","responsive":true,"className":""} -->

https://twitter.com/fuzzyKB/status/1320831517497511936

_Apropos reminder of Mac OS X's FreeBSD roots, which are still tangled with its parent's_

<!-- /wp:embed -->

<!-- wp:paragraph -->

[CBSD](https://cbsd.io/) will simplify managing your bhyve VMs, but first I want to create some manually, more or less, to get a taste of what goes on under the hood.

<!-- /wp:paragraph -->

<!-- wp:heading -->

## My First Guest

<!-- /wp:heading -->

<!-- wp:paragraph -->

First, I'm going to create a simple FreeBSD 11.4 guest. I've downloaded the 11.4 ISO image. The standard FreeBSD 13.0-CURRENT `userworld` installation has the [`bhyve` command-line interface (CLI)](https://www.freebsd.org/cgi/man.cgi?query=bhyve&sektion=8) in `/usr/sbin` and also ships with a wrapper script, `/usr/share/examples/bhyve/vmrun.sh`.

<!-- /wp:paragraph -->

<!-- wp:embed {"url":"https:\/\/gist.github.com\/kbruner\/524520af3d507987d4e546c56de5714c","type":"rich","providerNameSlug":"embed","className":""} -->

https://gist.github.com/kbruner/524520af3d507987d4e546c56de5714c

<!-- /wp:embed -->

<!-- wp:paragraph -->

At this point, it should boot the FreeBSD installer/LiveCD image. If you let it go, it starts the installer or it may ask for console type first. (FYI, `cons25w` works best when I ssh to the FreeBSD host from my Chromebook Linux terminal.)

<!-- /wp:paragraph -->

<!-- wp:paragraph -->

`nucklehead` gets its network configuration from my router's DHCP service. `bridge0` will also need an IP address. I ran `dhclient bridge0` to get another IP address on my LAN from router via DHCP. `em0` is the NUC's ethernet interface.

<!-- /wp:paragraph -->

<!-- wp:image {"id":923,"sizeSlug":"large","linkDestination":"none"} -->

![Screen shot of FreeBSD installer progress meter]({{ site.baseurl }}/assets/images/2020/10/screenshot-2020-10-28-at-21.27.23-01.jpeg?w=636)

<!-- /wp:image -->

<!-- wp:paragraph -->

Once the installation finishes, you can use the `Shell` option to exit the VM so you can boot off the disk image.

<!-- /wp:paragraph -->

<!-- wp:embed {"url":"https:\/\/gist.github.com\/kbruner\/531df9737589f23374e91a43949825b1","type":"rich","providerNameSlug":"embed","className":""} -->

https://gist.github.com/kbruner/531df9737589f23374e91a43949825b1

<!-- /wp:embed -->

<!-- wp:paragraph -->

…

<!-- /wp:paragraph -->

<!-- wp:embed {"url":"https:\/\/gist.github.com\/kbruner\/370983780fdc99d939a43d0d4d66ebe2","type":"rich","providerNameSlug":"embed","className":""} -->

https://gist.github.com/kbruner/370983780fdc99d939a43d0d4d66ebe2

<!-- /wp:embed -->

<!-- wp:paragraph -->

The `vmm` kernel driver keeps a device file for each running VM:

<!-- /wp:paragraph -->

<!-- wp:embed {"url":"https:\/\/gist.github.com\/kbruner\/921b4cef9f99a750dcec5ffe5900cc50","type":"rich","providerNameSlug":"embed","className":""} -->

https://gist.github.com/kbruner/921b4cef9f99a750dcec5ffe5900cc50

<!-- /wp:embed -->

<!-- wp:paragraph -->

If I shut down the VM, the `vmm` driver should remove it. If the device file persists after you think you have shut down the VM or `bhyve` exited with an error, you can remove the running VM with `bhyvectl --destroy --vm=MYVMNAME`. If no VMs remain, `vmm.ko` should also remove the directory `/dev/vmm`.

<!-- /wp:paragraph -->

<!-- wp:embed {"url":"https:\/\/gist.github.com\/kbruner\/449ee0e2cb3df6cbf66e66ba5d6b5473","type":"rich","providerNameSlug":"embed","className":""} -->

https://gist.github.com/kbruner/449ee0e2cb3df6cbf66e66ba5d6b5473

<!-- /wp:embed -->

<!-- wp:heading -->

## Linux Guest

<!-- /wp:heading -->

<!-- wp:jetpack/markdown {"source":"bhyve also supports Linux for guest VMs.\n\nNote that Linux VMs require the `grub-bhyve` utility from the `sysutils\/grub2-bhyve` [port](https:\/\/www.freebsd.org\/ports\/). If you just installed FreeBSD on your hypervisor and have not installed any ports yet, you will probably need to wait awhile (all night) while the dependencies compile. Plan accordingly."} -->

bhyve also supports Linux for guest VMs.

Note that Linux VMs require the `grub-bhyve` utility from the `sysutils/grub2-bhyve` [port](https://www.freebsd.org/ports/). If you just installed FreeBSD on your hypervisor and have not installed any ports yet, you will probably need to wait awhile (all night) while the dependencies compile. Plan accordingly.

<!-- /wp:jetpack/markdown -->

<!-- wp:heading -->

## High-Maintenance FreeBSD Guest

<!-- /wp:heading -->

<!-- wp:jetpack/markdown {"source":"While we wait for the `grub-bhyve` port and its dependencies to compile, let's see what it takes to run a FreeBSD guest without the `vmrun.sh` helper script.\n\nIf we haven't rebooted since our first experiment and don't have any other VMs running, we shouldn't need to (re)create the network interfaces. We will create a new `img` file, though.\n\nI tried to create a FreeBSD VM building off the `bhyve(8)` man page but I kept getting errors like `virtual machine cannot be booted`. So I figured the `vmrun.sh` wrapper script was responsible for more magic than just the `bhyve` command line. I made a copy, added `set -x` to capture the actual commands it was running, and then spent 15 minutes trying to figure out why my file handle redirects weren't working as intended. Oh. I forgot `root` defaults to `\/bin\/csh` on FreeBSD.\n"} -->

While we wait for the `grub-bhyve` port and its dependencies to compile, let's see what it takes to run a FreeBSD guest without the `vmrun.sh` helper script.

If we haven't rebooted since our first experiment and don't have any other VMs running, we shouldn't need to (re)create the network interfaces. We will create a new `img` file, though.

I tried to create a FreeBSD VM building off the `bhyve(8)` man page but I kept getting errors like `virtual machine cannot be booted`. So I figured the `vmrun.sh` wrapper script was responsible for more magic than just the `bhyve` command line. I made a copy, added `set -x` to capture the actual commands it was running, and then spent 15 minutes trying to figure out why my file handle redirects weren't working as intended. Oh. I forgot `root` defaults to `/bin/csh` on FreeBSD.

<!-- /wp:jetpack/markdown -->

<!-- wp:embed {"url":"https:\/\/twitter.com\/fuzzyKB\/status\/1321867141587570695","type":"rich","providerNameSlug":"twitter","responsive":true,"className":""} -->

https://twitter.com/fuzzyKB/status/1321867141587570695

<!-- /wp:embed -->

<!-- wp:paragraph -->

Anyway, yes, the script was doing more. There's this thing called a boot loader, see…

<!-- /wp:paragraph -->

<!-- wp:embed {"url":"https:\/\/gist.github.com\/kbruner\/460b5f2aa34cba61dda8adfe8850497d","type":"rich","providerNameSlug":"embed","className":""} -->

https://gist.github.com/kbruner/460b5f2aa34cba61dda8adfe8850497d

<!-- /wp:embed -->

<!-- wp:paragraph -->

The loader menu appears…

<!-- /wp:paragraph -->

<!-- wp:embed {"url":"https:\/\/gist.github.com\/kbruner\/57e1066e27a09ce2fd3bcf86b9446d09","type":"rich","providerNameSlug":"embed","className":""} -->

https://gist.github.com/kbruner/57e1066e27a09ce2fd3bcf86b9446d09

<!-- /wp:embed -->

<!-- wp:paragraph -->

And if all goes well, it should boot the installer/live cd image and off you go.

<!-- /wp:paragraph -->

<!-- wp:paragraph -->

A couple tips:

<!-- /wp:paragraph -->

<!-- wp:list -->

- When creating FreeBSD guests, you will always need to run the `bhyveload` command first.
- Make sure the RAM size in the `bhyveload` and `bhyve` `-m` arguments match, or you will get the error `Unable to setup memory (22)`. (Ask me how I know.)
- When you're done with the VM, you may have to clean up manually with `bhyvectl --destroy --vm=highmaintenance`.

<!-- /wp:list -->

<!-- wp:paragraph -->

The `-s #,...` options are my favorite. They create virtual PCI slots. (Be sure to check out the [`bhyve` man page](https://www.freebsd.org/cgi/man.cgi?query=bhyve&sektion=8).) I am now having flashbacks to setting up CD burners on my home FreeBSD desktop a bazillion years ago.

<!-- /wp:paragraph -->

<!-- wp:separator -->

* * *
<!-- /wp:separator -->

<!-- wp:paragraph -->

[The next post](https://productionwithscissors.run/2020/10/31/adventures-in-freebernetes-will-linux-bhyve/) in this series will cover creating your Linux guest manually with `bhyve`. By then, with luck, your `/usr/ports` tree should have finished compiling.

<!-- /wp:paragraph -->

<!-- wp:heading -->

## Sources / References

<!-- /wp:heading -->

<!-- wp:list -->

- [http://empt1e.blogspot.com/2016/10/bhyve-networking-options.html](http://empt1e.blogspot.com/2016/10/bhyve-networking-options.html)
- [https://en.wikipedia.org/wiki/Bhyve](https://en.wikipedia.org/wiki/Bhyve)
- [https://wiki.freebsd.org/bhyve](https://wiki.freebsd.org/bhyve)
- [https://www.freebsd.org/doc/handbook/virtualization-host-bhyve.html](https://www.freebsd.org/doc/handbook/virtualization-host-bhyve.html)

<!-- /wp:list -->

<!-- wp:paragraph -->

<!-- /wp:paragraph -->

