---
layout: post
title: 'Adventures in Freebernetes: Certs, Certs, DNS, More Certs'
date: 2020-11-26 00:36:37.000000000 -08:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- FreeBSD Virtualization
tags:
- dns
- freebsd
- ipv4
- kubernetes
- linux
- virtualization
meta:
  _last_editor_used_jetpack: block-editor
  _thumbnail_id: '0'
  _wpcom_is_markdown: '1'
  _oembed_783ce91522136c3d54332a75c68a3c32: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="550" data-dnt="true"><p lang="en" dir="ltr">I
    won&#39;t give out and do not want the root password on a Linux host ever again,
    but I cannot bring myself to install sudo on my personal FreeBSD machines.<br><br>wheel
    group and su -<br><br>That is the way.</p>&mdash; Karen Bruner (@fuzzyKB) <a href="https://twitter.com/fuzzyKB/status/1330424565772791813?ref_src=twsrc%5Etfw">November
    22, 2020</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_783ce91522136c3d54332a75c68a3c32: '1606352564'
  _oembed_311a6887ab54a78898d38aead43f2a87: "{{unknown}}"
  _oembed_b888abc0a2e55f0924270ac6641252a1: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="500" data-dnt="true"><p lang="en" dir="ltr">I
    won&#39;t give out and do not want the root password on a Linux host ever again,
    but I cannot bring myself to install sudo on my personal FreeBSD machines.<br><br>wheel
    group and su -<br><br>That is the way.</p>&mdash; Karen Bruner (@fuzzyKB) <a href="https://twitter.com/fuzzyKB/status/1330424565772791813?ref_src=twsrc%5Etfw">November
    22, 2020</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _publicize_job_id: '51484384475'
  timeline_notification: '1606351001'
  _oembed_b9ac78fe259d186745598ed987c7c824: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="550" data-dnt="true"><p lang="en" dir="ltr">I
    won&#39;t give out and do not want the root password on a Linux host ever again,
    but I cannot bring myself to install sudo on my personal FreeBSD machines.<br><br>wheel
    group and su -<br><br>That is the way.</p>&mdash; Karen Bruner (@fuzzyKB) <a href="https://twitter.com/fuzzyKB/status/1330424565772791813?ref_src=twsrc%5Etfw">November
    22, 2020</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_b9ac78fe259d186745598ed987c7c824: '1606351002'
  _oembed_08738dfc3379ca8621d3cfd6a78cc361: "{{unknown}}"
  _oembed_ed377b4ee7a4a1c1e1e187d0337ee590: "{{unknown}}"
  _oembed_eede1259dba14115ceefc08f839775bf: <div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="550" data-dnt="true"><p lang="en" dir="ltr">I
    won&#39;t give out and do not want the root password on a Linux host ever again,
    but I cannot bring myself to install sudo on my personal FreeBSD machines.<br><br>wheel
    group and su -<br><br>That is the way.</p>&mdash; Karen Bruner (@fuzzyKB) <a href="https://twitter.com/fuzzyKB/status/1330424565772791813?ref_src=twsrc%5Etfw">November
    22, 2020</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>
  _oembed_time_eede1259dba14115ceefc08f839775bf: '1606351003'
  _oembed_47dd70901e633fddc5b0e07d29a3d68e: "{{unknown}}"
  _oembed_256d503276b280fbf7ce1d36e53bace2: "{{unknown}}"
  _oembed_time_b888abc0a2e55f0924270ac6641252a1: '1606351029'
  _oembed_e98d1ddcc9f99d0b1f2fb783e0777d88: "{{unknown}}"
  _oembed_b7609a4484ea122d55bb0a30ba192ea6: "{{unknown}}"
  _oembed_666fce4c34941abfc64b27d737474292: "{{unknown}}"
  _oembed_a7eca547f30f78bdfe25e56c17761eff: "{{unknown}}"
  _oembed_e79b32b4db433d4ec4c67ae22a10d41c: "{{unknown}}"
author:
  login: nightmarebeforedevops
  email: kbcontactxyz@gmail.com
  display_name: karenb
  first_name: Karen
  last_name: Bruner
permalink: "/2020/11/26/adventures-in-freebernetes-certs-certs-dns-more-certs/"
excerpt: 'Part 10 of experiments in FreeBSD and Kubernetes: More Net Work Plus Initial
  Cluster Creation Tasks'
---
<p><!-- wp:paragraph {"fontSize":"medium"} --></p>
<p class="has-medium-font-size"><em>Part 10 of experiments in FreeBSD and Kubernetes: More Net Work Plus Initial Cluster Creation Tasks</em></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph {"fontSize":"normal"} --></p>
<p class="has-normal-font-size"><a href="https://productionwithscissors.run/freebsd-virtualization-series/"><em>See all posts in this series</em></a></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>Table of Contents</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:html --></p>
<div class="toc">
<ol>
<li><a href="#provisioning-compute-resources">Provisioning Compute Resources</a></li>
<ul>
<li><a href="#rabbit-hole-1-dns">Rabbit Hole #1: DNS</a></li>
<li><a href="#creating-instances">Creating Instances</a></li>
</ul>
<li><a href="#generating-certificate-authority">Generating the Certificate Authority and Certs</a></li>
<ul>
<li><a href="#rabbit-hole-2-fake-load-balancing">Rabbit Hole #2: Fake Load Balancing</a></li>
<li><a href="#back-to-certificates">Back to the Certificates</a></li>
</ul>
<li><a href="#generating-kubernetes-configuration-files">Generating Kubernetes Configuration Files for Authentication</a></li>
<li><a href="#generating-data-encryption-config">Generating the Data Encryption Config and Key</a></li>
<li><a href="#sources-references">Sources / References</a></li>
</ol>
<p>
</div>
<p><!-- /wp:html --></p>
<p><!-- wp:paragraph --></p>
<p>In <a href="https://productionwithscissors.run/2020/11/24/adventures-in-freebernetes-getting-ready-to-do-kubernetes-the-harder-way/">the previous post</a> in this series, I had finished creating <a href="https://productionwithscissors.run/2020/11/24/adventures-in-freebernetes-getting-ready-to-do-kubernetes-the-harder-way/#great-image-bake-off-season-2">a raw image of Ubuntu Server 20.04</a> with cloud-init configured for use with CBSD to create <code>bhyve</code> virtual machines. I also <a href="https://productionwithscissors.run/2020/11/24/adventures-in-freebernetes-getting-ready-to-do-kubernetes-the-harder-way/#command-and-ctl">installed the tools</a> I would need to work through the <a href="https://github.com/kelseyhightower/kubernetes-the-hard-way">Kubernetes the Hard Way</a> tutorials to create a Kubernetes cluster completely manually, and <a href="https://productionwithscissors.run/2020/11/24/adventures-in-freebernetes-getting-ready-to-do-kubernetes-the-harder-way/#nat-done-yet">I configured <code>ipfw</code></a> on my FreeBSD hypervisor to act as a NAT (Network Address Translation service) so my VMs, which have their own private network, can still reach sites on the Internet. I will still have <a href="https://productionwithscissors.run/2020/11/24/adventures-in-freebernetes-getting-ready-to-do-kubernetes-the-harder-way/#make-the-net-work">a few details to work out</a>, mainly around Kubernetes cluster networking, but I should be ready to start.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>A few details for reference:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li>My hypervisor is named <code>nucklehead</code> (it's an Intel NUC) and is running FreeBSD 13.0-CURRENT</li>
<li>My home network, including the NUC, is in the 192.168.0.0/16 space</li>
<li>The Kubernetes cluster will be in the 10.0.0.0/8 block, which exists solely on my FreeBSD host</li>
<li>Yes, I am just hanging out in a root shell on the hypervisor.</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:embed {"url":"https:\/\/twitter.com\/fuzzyKB\/status\/1330424565772791813","type":"rich","providerNameSlug":"twitter","responsive":true,"className":""} --></p>
<figure class="wp-block-embed is-type-rich is-provider-twitter wp-block-embed-twitter">
<div class="wp-block-embed__wrapper">
https://twitter.com/fuzzyKB/status/1330424565772791813
</div>
</figure>
<p><!-- /wp:embed --></p>
<p><!-- wp:heading --></p>
<h2 id="provisioning-compute-resources"><a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/1.18.6/docs/03-compute-resources.md">Provisioning Compute Resources</a></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>I've already done the relevant initial steps and skipped those that are specific to GCP, so now I need to <a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/1.18.6/docs/03-compute-resources.md#compute-instances">create the VMs</a> for the cluster. In the previous post, I generated a VM settings file to use with CBSD in order to make consistent creation simpler from the command-line.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 id="rabbit-hole-1-dns">Rabbit Hole #1: DNS</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>I started creating VMs before I remembered one <a href="https://productionwithscissors.run/2020/11/24/adventures-in-freebernetes-getting-ready-to-do-kubernetes-the-harder-way/#make-the-net-work">network detail</a> I had punted in the previous post: hostname resolution. I could just do low-initial-friction-but-potentially-annoying-later-on solution of hardcoding the cluster members into <code>/etc/hosts</code> on all the VMs and the hypervisor, but that solution, while perfectly serviceable, would not be <em>the harder way</em> of solving my resolution issues. Yes, I need to set up a DNS server locally on FreeBSD.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>FreeBSD offers the recursive-only server <code>Unbound</code> in its base system. However, I need an authoritative server for my <code>.local</code> domain. NSD (Name Server Daemon) can only operate as an authoritative server, so between the two, my DNS resolution problems would be solved. I install the <code>dns/nsd</code> port and start configuring.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>I follow <a href="https://blog.socruel.nu/freebsd/how-to-implement-unbound-and-nsd-on-freebsd.html">this Unbound/NSD tutorial</a> for setting up the two services on FreeBSD to serve a private domain. I name my domain <code>something.local</code> because I just can't think of anything clever right now. I get both services configured and now I can resolve stuff from the host.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:embed {"url":"https:\/\/gist.github.com\/kbruner\/c11447a56157bbf6c2d72a03827ceea8","type":"rich","providerNameSlug":"embed","className":""} --></p>
<figure class="wp-block-embed is-type-rich is-provider-embed wp-block-embed-embed">
<div class="wp-block-embed__wrapper">
https://gist.github.com/kbruner/c11447a56157bbf6c2d72a03827ceea8
</div>
<figcaption><em>I don't know why WordPress forces http:// on "www.google.com" but, no, it's not in the gist, and yes, it's annoying the crap out of me</em></figcaption>
</figure>
<p><!-- /wp:embed --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 id="creating-instances">Creating Instances</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p><a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/1.18.6/docs/03-compute-resources.md#kubernetes-controllers">The Kubernetes the Hard Way tutorial</a> uses the GCE <a href="https://cloud.google.com/compute/docs/machine-types#e2_standard_machine_types"><code>e2-standard-2</code> GCE machine type</a>, which have 2 virtual CPUs and 8Gb RAM. I need three VMs for the control plane and three for the worker nodes.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Apparently I also need to pass the pod CIDR for each node (they can't share address ranges) in via the VM metadata. I will quickly try to accomplish this by creating a new cloud-init template for CBSD (by copying the <code>centos7</code> template I'm currently using) in <code>/usr/local/cbsd/modules/bsdconf.d/cloud-tpl</code> and add a field for called <code>pod-cidr</code> in the <code>meta-data</code> file. If it works, great. If not, I may try to find another way to inject/distribute the value. Oh, who am I kidding. I will fiddle with it endlessly until I find a way to shove that value through cloud-init.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>It turns out I also needed to update the default cloud-init template's network configuration format from version 1 to version 2, because some settings, such as the default gateway, were not getting applied.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:embed {"url":"https:\/\/gist.github.com\/kbruner\/93a74c451370cd28f5b35dd86fe7b55d","type":"rich","providerNameSlug":"embed","className":""} --></p>
<figure class="wp-block-embed is-type-rich is-provider-embed wp-block-embed-embed">
<div class="wp-block-embed__wrapper">
https://gist.github.com/kbruner/93a74c451370cd28f5b35dd86fe7b55d
</div>
</figure>
<p><!-- /wp:embed --></p>
<p><!-- wp:paragraph --></p>
<p>I add the <code>ci_pod_cidr</code> field to my VM settings file and update my VM template in <code>/usr/cbsd/etc/defaults</code> to use the new cloud-init template. I also have to add the new variable to the script <code>/usr/cbsd/modules/cloudinit</code> so it will be interpolated in the generated files.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>For reference, here are the values I am using when creating my cluster instances:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li>VM size: 2 CPUs, 8 Gb RAM</li>
<li>Node network CIDR block: 10.10.0.0/24</li>
<li>Pod network CIDR block: 10.100.0.0/16</li>
<li>Root disk: 10Gb <em>Ok, the tutorial uses 200Gb root disks, but that's the size of my entire ZFS pool, so no. If I regret this later, I should be able to resize the underlying ZFS volumes. Theoretically.</em></li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:embed {"url":"https:\/\/gist.github.com\/kbruner\/6ebc18605892ef2a234c76f8699b0524","type":"rich","providerNameSlug":"embed","className":""} --></p>
<figure class="wp-block-embed is-type-rich is-provider-embed wp-block-embed-embed">
<div class="wp-block-embed__wrapper">
https://gist.github.com/kbruner/6ebc18605892ef2a234c76f8699b0524
</div>
</figure>
<p><!-- /wp:embed --></p>
<p><!-- wp:paragraph --></p>
<p>Then I do the same thing again, except the hostnames have the prefix <code>worker-</code> and I also pass the <code>ci_pod_cidr</code> key-value pair to <code>cbsd bcreate</code>. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:embed {"url":"https:\/\/gist.github.com\/kbruner\/fae8c4ff65731ec9ea9ecbebaf9dc087","type":"rich","providerNameSlug":"embed","className":""} --></p>
<figure class="wp-block-embed is-type-rich is-provider-embed wp-block-embed-embed">
<div class="wp-block-embed__wrapper">
https://gist.github.com/kbruner/fae8c4ff65731ec9ea9ecbebaf9dc087
</div>
<figcaption><em>My cluster VMs, plus the </em><code>ubuntu-base</code> VM, which is turned off</figcaption>
</figure>
<p><!-- /wp:embed --></p>
<p><!-- wp:paragraph --></p>
<p>The instances are all running with the correct hostnames and IP addresses, and DNS resolves properly on the host and in the VMs. CBSD sets the SSH key for the <code>ubuntu</code> user in the VM, so everything is ready for the next step.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading --></p>
<h2 id="generating-certificate-authority"><a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/1.18.6/docs/04-certificate-authority.md">Generating the Certificate Authority and Certs</a></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>This section is mostly pretty straightforward, other than replacing the <code>gcloud</code> commands with appropriate calls and omitting the non-existent external IP address. Since I setup DNS, I could just do this to look up the instance IP addresses: <code>INTERNAL_IP=$(host $instance | awk '{print $4}')</code></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 id="rabbit-hole-2-fake-load-balancing">Rabbit Hole #2: Fake Load Balancing</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>However, when it comes time to generate the API server certificate, I need to supply the IP address for the endpoint, which, in the tutorial, is a Google Cloud load balancer. As I mentioned in <a href="https://productionwithscissors.run/2020/11/24/adventures-in-freebernetes-getting-ready-to-do-kubernetes-the-harder-way/#make-the-net-work">the previous post</a>, I don't really want to run my own load balancer service for this experiment. I thought I could use FreeBSD's <code><a href="https://www.freebsd.org/doc/handbook/carp.html">carp(4)</a></code> module to simulate basic load balancer functionality, but it doesn't quite work that way.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>However, I <em>can</em> use <code><a href="https://www.freebsd.org/cgi/man.cgi?ipfw">ipfw(4)</a></code> module. I'm already using <code>ipfw</code> to handle Network Address Translation for my cluster network.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:embed {"url":"https:\/\/gist.github.com\/kbruner\/978b281eaaf2e7ebf282d7125bd024e0","type":"rich","providerNameSlug":"embed","className":""} --></p>
<figure class="wp-block-embed is-type-rich is-provider-embed wp-block-embed-embed">
<div class="wp-block-embed__wrapper">
https://gist.github.com/kbruner/978b281eaaf2e7ebf282d7125bd024e0
</div>
</figure>
<p><!-- /wp:embed --></p>
<p><!-- wp:paragraph --></p>
<p>Here I create forwarding rules, one for each of the three controller hosts. Each rule matches traffic from any source to 10.10.0.1, the IP address I chose for the <code>kube-apiserver</code>. However, they each forward to a different controller host. The <code>prob</code> argument assigns a 1/3 chance of matching rule 200, a 1/2 chance (as rule 200 would already have failed to match) of matching rule 201, and rule 202 has a 100% chance of matching if the previous two rules failed. This effectively gives each backend a 33% chance of receiving a given connection that was made to 10.10.0.1. The <code>keep-state</code> argument ensures that all the packets in a TCP stream go to the same backend server.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Perhaps not so coincidentally, <a href="https://kubernetes.io/docs/concepts/services-networking/service/#proxy-mode-iptables"><code>kube-proxy</code> in <code>iptables</code></a> mode uses an analogous version of round-robin load balancing traffic to a <a href="https://www.stackrox.com/post/2020/01/kubernetes-networking-demystified/"><code>Service</code>'s virtual IP address</a> across the backend pods for that service.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Anyway, I also add the <code>kube-apiserver</code>'s 10.10.0.1 virtual IP to each of the controllers so they will accept traffic to that IP. And, as you can see above, if I <code>ssh</code> (the only TCP service the VMs had running at this point) to 10.10.0.1, I get a different host when I connect.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>I also add an <code>A</code> record for <code>kubernetes</code> and the new IP to my <code>something.local</code> zone.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 id="back-to-certificates">Back to the Certificates</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>Now that I have the virtual endpoint set up, I can use its IP address to generate the <code>kube-apiserver</code> certificate.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading --></p>
<h2 id="generating-kubernetes-configuration-files"><a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/1.18.6/docs/05-kubernetes-configuration-files.md">Generating Kubernetes Configuration Files for Authentication</a></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>This section is very straightforward. The only modifications necessary involved replacing a couple <code>gcloud</code> commands.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading --></p>
<h2 id="generating-data-encryption-config"><a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/1.18.6/docs/06-data-encryption-keys.md">Generating the Data Encryption Config and Key</a></h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>This section requires swapping the Linux standard <code>base64</code> command with FreeBSD's <code>b64encode</code>: <code>ENCRYPTION_KEY=$(head -c 32 /dev/urandom | b64encode -r -)</code></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:separator --></p>
<hr class="wp-block-separator" />
<!-- /wp:separator --></p>
<p><!-- wp:paragraph --></p>
<p>Now that my cluster has all the certificates and other cluster authentication files, the <a href="https://productionwithscissors.run/2020/11/28/adventures-in-freebernetes-my-out-of-control-plane/">next post</a> will pick up at the next step: bootstrapping <code>etcd</code>.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading --></p>
<h2 id="sources-references">Sources / References</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:list --></p>
<ul>
<li><a href="https://blog.socruel.nu/freebsd/how-to-implement-unbound-and-nsd-on-freebsd.html">https://blog.socruel.nu/freebsd/how-to-implement-unbound-and-nsd-on-freebsd.html</a></li>
<li><a rel="noreferrer noopener" href="https://github.com/kelseyhightower/kubernetes-the-hard-way" target="_blank">https://github.com/kelseyhightower/kubernetes-the-hard-way</a></li>
<li><a href="https://www.freebsd.org/doc/handbook/firewalls-ipfw.html">https://www.freebsd.org/doc/handbook/firewalls-ipfw.html</a></li>
<li><a href="https://www.freebsd.org/doc/handbook/network-dns.html">https://www.freebsd.org/doc/handbook/network-dns.html</a></li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></p>
