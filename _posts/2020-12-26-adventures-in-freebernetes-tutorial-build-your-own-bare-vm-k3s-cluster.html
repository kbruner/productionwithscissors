---
layout: post
title: 'Adventures in Freebernetes Tutorial: Build Your Own Bare-VM k3s Cluster'
date: 2020-12-26 08:38:07.000000000 -08:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- FreeBSD Virtualization
tags:
- freebsd
- kubernetes
- tutorial
- virtualization
meta:
  _last_editor_used_jetpack: block-editor
  _wpcom_is_markdown: '1'
  _wp_desired_post_slug: ''
  timeline_notification: '1608971891'
  _oembed_c3d31d53cfe35e2014d3a18d029da03b: "{{unknown}}"
  _publicize_job_id: '52664980684'
  _edit_last: '108235749'
author:
  login: nightmarebeforedevops
  email: kbcontactxyz@gmail.com
  display_name: karenb
  first_name: Karen
  last_name: Bruner
permalink: "/2020/12/26/adventures-in-freebernetes-tutorial-build-your-own-bare-vm-k3s-cluster/"
excerpt: Step-by-step tutorial for deploying a Kubernetes cluster with k3s on FreeBSD
  bhyve VMs
---
<p><!-- wp:paragraph {"fontSize":"medium"} --></p>
<p class="has-medium-font-size"><em>Step-by-step tutorial for deploying a Kubernetes cluster with k3s on FreeBSD bhyve VMs</em></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><a href="https://productionwithscissors.run/freebsd-virtualization-series/">See all posts in the FreeBSD Virtualization Series</a></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:html --></p>
<div class="toc">
<ol>
<li><a href="#overview">Overview</a></li>
<ul>
<li><a href="#intended-audience">Intended Audience</a></li>
</ul>
<li><a href="#technical-specs">Technical Specs</a></li>
<ul>
<li><a href="#cluster-specs">Kubernetes Cluster Specs</a></li>
<li><a href="#host-requirements">Host Requirements</a></li>
<li><a href="#test-system">My Test System</a></li>
</ul>
<li><a href="2/#part-1">Part 1: Required Tools</a></li>
<li><a href="3/#part-2">Part 2: Building k3sup</a></li>
<li><a href="4/#part-3">Part 3: Creating VMs</a></li>
<li><a href="5/#part-4">Part 4: Configure Networking</a></li>
<li><a href="6/#part-5">Part 5: Create the Cluster</a></li>
<li><a href="7/#part-6">Part 6: Test the Cluster</a></li>
<li><a href="8/#part-7">Part 7: Clean Up</a></li>
<li><a href="8/#sources-references">Sources / References</a></li>
</ol>
<p>
</div>
<p><!-- /wp:html --></p>
<p><!-- wp:heading --></p>
<h2 id="overview">Overview</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>In <a href="https://productionwithscissors.run/2020/12/08/adventures-in-freebernetes-tutorial-build-your-own-bare-vm-kubernetes-cluster-the-hard-way/">the last tutorial</a> in this series, we went through the steps of creating a Kubernetes cluster on FreeBSD <code>bhyve</code> VMs, adapting the completely manual process in Kelsey Hightower's <a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/tree/1.18.6">Kubernetes the Hard Way</a>. This tutorial will also build a Kubernetes cluster on <code>bhyve</code>, but it will install a lightweight <code><a href="https://k3s.io/">k3s</a></code> control plane using the <a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/"><code>k3sup</code></a> tool, which automates much of the process.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Topics covered:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li>Compiling <code>k3sup</code> on FreeBSD</li>
<li>Configuring CBSD to create and manage <code>bhyve</code> VMs</li>
<li>Running <code>k3sup</code> to bring up a <code>k3s</code> cluster on <code>bhyve</code> VMs</li>
<li>Configuring the FreeBSD firewall, DNS, and routing for cluster networking</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p>While this tutorial builds a cluster with a redundant control plane, all the VMs are on a single hypervisor, making it suitable for testing and experimentation, but it is not production grade.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>This tutorial only covers creating a cluster. For Kubernetes basics and terminology, you should start with the <a href="https://kubernetes.io/">official Kubernetes documentation</a>.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 id="intended-audience">Intended Audience</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>For this tutorial, you don't need to know anything about Kubernetes. You do need to have a host with FreeBSD installed; an understanding of basic FreeBSD system administration tasks, such as installing software from FreeBSD ports or packages, and loading kernel modules; and familiarity with <code>csh</code> or <code>sh</code>. Experience with FreeBSD <code>bhyve</code> virtual machines and the CBSD interface is useful but not required.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading --></p>
<h2 id="technical-specs">Technical Specs</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 id="cluster-specs">Kubernetes Cluster Specs</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>We will use these targets for the Kubernetes cluster we're building. Most of these settings can be adjusted.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li>Control plane ("K3s servers")
<ul>
<li>3 VMs: 2 CPU cores, 2Gb RAM, 20Gb virtual disk each</li>
<li>If you plan on creating more than 10 worker nodes, increase the control plane VM sizes</li>
</ul>
</li>
<li>Worker nodes ("K3s agents")
<ul>
<li>3 VMs: 2 CPU cores, 2Gb RAM, 10Gb virtual disk each</li>
</ul>
</li>
<li>VM OS: Ubuntu Server 20.04</li>
<li>Kubernetes version: 1.19</li>
<li>Control plane backing database: embedded <code>etcd</code>
<ul>
<li>K3s also supports using an external datastore, such as MySQL</li>
</ul>
</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 id="host-requirements">Host (FreeBSD Hypervisor) Requirements</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:list --></p>
<ul>
<li>Hardware, physical or virtual
<ul>
<li>CPU
<ul>
<li>CPUs must support FreeBSD bhyve virtualization (see <a href="https://www.freebsd.org/doc/handbook/virtualization-host-bhyve.html">the FreeBSD Handbook page on bhyve</a> for compatible CPUs)</li>
<li>CPU core allocations for <code>bhyve</code> VMs are completely virtual, so you can have VMs running with a total virtual core count greater than your host system's. You should use the suggested core count for VMs, as Kubernetes will use those for scheduling. You can increase the cores if you have a larger host.</li>
</ul>
</li>
</ul>
<ul>
<li>RAM: Minimum 2Gb per VM. You can use less for the agent VMs if necessary.</li>
</ul>
<ul>
<li>Free disk space: 100Gb</li>
</ul>
</li>
<li>Operating system
<ul>
<li>FreeBSD: 13.0-CURRENT. It may work with 12.0-RELEASE, but it has not been tested</li>
<li>File system: ZFS</li>
</ul>
</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 id="test-system">My Test System</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:list --></p>
<ul>
<li>Hardware
<ul>
<li>CPUs: Intel(R) Core(TM) i5-6260U: 4 CPUs, 2 cores each</li>
<li>RAM: 32Gb</li>
</ul>
</li>
<li>Operating system
<ul>
<li>FreeBSD 13.0-HEAD-f659bf1d31c</li>
</ul>
</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p><a href="2">Next -&gt;</a></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:nextpage --><br />
<!--nextpage--><br />
<!-- /wp:nextpage --></p>
<p><!-- wp:heading --></p>
<h2 id="part-1">Part 1: Required Tools</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>We're going to install the tools needed on the FreeBSD hypervisor. <a href="https://www.freebsd.org/doc/handbook/ports.html">You can compile from the </a><a href="https://www.freebsd.org/doc/handbook/ports.html"><code>ports</code></a><a href="https://www.freebsd.org/doc/handbook/ports.html"> tree or install from packages</a>, whichever you prefer. The tutorial assumes you have already installed all these ports. When additional post-installation configuration is required, we will walk through it at the appropriate point in the tutorial.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>We need to build <code>k3sup</code> locally, so this list includes the build tools for compiling from source.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Here is the full list of required packages, including the versions, with the <code>ports</code> section in parentheses:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li>Build tools
<ul>
<li>git 2.29.2 (<code>devel</code>)</li>
</ul>
<ul>
<li>go 1.15.6.1 (<code>lang</code>)</li>
</ul>
</li>
<li>K8s tools
<ul>
<li>kubectl 1.19.4 (<code>sysutils</code>)</li>
</ul>
</li>
<li>FreeBSD system tools
<ul>
<li><code>CBSD</code> 12.2.4 (<code>sysutils</code>)</li>
<li><code>nsd</code> 4.3.4 (<code>dns</code>)</li>
</ul>
</li>
<li>Misc tools
<ul>
<li><code>wget</code> 1.20.3_1 (<code>ftp</code>)</li>
</ul>
</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p><a href="../3">Next -&gt;</a></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:nextpage --><br />
<!--nextpage--><br />
<!-- /wp:nextpage --></p>
<p><!-- wp:heading --></p>
<h2 id="part-2">Part 2: Build k3sup</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:html --></p>
<li><a href="#2-1">2.1 Setup Your Go Environment</a></li>
<li><a href="#2-2">2.2 Check Out and Build k3sup</a></li>
<p><!-- /wp:html --></p>
<p><!-- wp:paragraph --></p>
<p>We'll need to build <code>k3sup</code> for our FreeBSD hypervisor.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 id="2-1">2.1 Setup Your Go Environment</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>If you already have a working <code>golang</code> build environment on your FreeBSD hypervisor, you can skip this section.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>First, create your <code>go</code> workspace. This tutorial will assume you are using the path <code>${HOME}/go</code>.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:embed {"url":"https://gist.github.com/kbruner/b7aa00bad106287d90453e487b23145b","type":"rich","providerNameSlug":"embed-handler"} --></p>
<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler">
<div class="wp-block-embed__wrapper">
https://gist.github.com/kbruner/b7aa00bad106287d90453e487b23145b
</div>
</figure>
<p><!-- /wp:embed --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 id="2-2">2.2 Check Out and Build k3sup</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:embed {"url":"https://gist.github.com/kbruner/663ba195adef9a7e8d99704c8ce5982a","type":"rich","providerNameSlug":"embed-handler"} --></p>
<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler">
<div class="wp-block-embed__wrapper">
https://gist.github.com/kbruner/663ba195adef9a7e8d99704c8ce5982a
</div>
</figure>
<p><!-- /wp:embed --></p>
<p><!-- wp:paragraph --></p>
<p>You should copy this <code>k3sup</code> binary somewhere in your <code>PATH</code>.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><a href="../4">Next -&gt;</a></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:nextpage --><br />
<!--nextpage--><br />
<!-- /wp:nextpage --></p>
<p><!-- wp:heading --></p>
<h2 id="part-3">Part 3: Create VMs</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:html --></p>
<li><a href="#3-1">3.1 Choose Your Network Layout</a></li>
<li><a href="#3-2">3.2 Create the Linux VMs</a></li>
<p><!-- /wp:html --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3>3.1 Choose Your Network Layout</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>3.1.1 Select Subnets</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>My FreeBSD hypervisor has a 192.168.0.0/24 address on its physical network interface. I'm going to use a VLAN in 10.0.0.0/8 for the cluster and its pods and services. You can use another block, but you will have to adjust commands throughout the tutorial.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li>10.0.0.1/32 - VLAN gateway on bridge interface</li>
<li>10.0.0.2/32 - Virtual IP for Kubernetes API endpoint</li>
<li>10.0.10.0/24 - VM block
<ul>
<li>10.0.10.1[1-3] - K3s servers</li>
<li>10.0.10.2[1-3] - K3s agents (nodes)</li>
</ul>
</li>
<li>10.1.0.0/16 - pod network</li>
<li>10.2.0.0/16 - service network</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>3.1.2 Pick a <code>.local</code> Zone for DNS</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>This zone just needs to resolve locally on the FreeBSD host. I'm going with <code>k3s.local</code> because I'm too lazy to think of a clever pun right now.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 id="3-2">3.2 Create the Linux VMs</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>3.2.1 Initialize CBSD</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>If you haven't run <a href="https://cbsd.io/">CBSD</a> on your FreeBSD host before, you will need to set it up. You can use <a href="https://github.com/kbruner/freebernetes/blob/main/k3s/cbsd/initenv.conf">this seed file</a>. Edit it first to set <code>node_name</code> to your FreeBSD host's name and to change <code>jnameserver</code> and <code>nodeippool</code> if you are using a private network other than <code>10.0.0.0/8</code>.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:embed {"url":"https://gist.github.com/kbruner/c4cf17fd603d55c5ef03925a161051b2","type":"rich","providerNameSlug":"embed-handler"} --></p>
<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler">
<div class="wp-block-embed__wrapper">
https://gist.github.com/kbruner/c4cf17fd603d55c5ef03925a161051b2
</div>
</figure>
<p><!-- /wp:embed --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>3.2.2 Create VMs</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>Copy <a href="https://github.com/kbruner/freebernetes/blob/main/k3s/cbsd/instance.jconf">this <code>instance.jconf</code> VM template file</a> and update <code>ci_gw4</code>, <code>ci_nameserver_search</code>, and <code>ci_nameserver_address</code> fields as needed. If you want to set a password for the <code>ubuntu</code> user in case you want to log in on the console via VNC, you can assign it to <code>cw_user_pw_user</code>, but note this is a plain-text field.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>When you run <code>cbsd bcreate</code>, if CBSD does not have a copy of the installation ISO image, it will prompt you asking to download it. After the first time, it will re-use the local image.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:embed {"url":"https://gist.github.com/kbruner/73d227a5b78e5c5f56f6584259357141","type":"rich","providerNameSlug":"embed-handler"} --></p>
<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler">
<div class="wp-block-embed__wrapper">
https://gist.github.com/kbruner/73d227a5b78e5c5f56f6584259357141
</div>
</figure>
<p><!-- /wp:embed --></p>
<p><!-- wp:paragraph --></p>
<p><a href="../5">Next -&gt;</a></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:nextpage --><br />
<!--nextpage--><br />
<!-- /wp:nextpage --></p>
<p><!-- wp:heading --></p>
<h2 id="part-4">Part 4: Configure Networking</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:html --></p>
<li><a href="#4-1">4.1 Add Bridge Gateways</a></li>
<li><a href="#4-2">4.2 Configure NAT</a></li>
<li><a href="#4-3">4.3 Configure Local DNS</a></li>
<p><!-- /wp:html --></p>
<p><!-- wp:paragraph --></p>
<p>You cannot connect to the new VMs yet. CBSD creates a <code><a href="https://www.freebsd.org/doc/handbook/network-bridging.html">bridge</a></code> interface the first time you create a VM. We need to add gateways for our cluster VLANs to that interface so we can route from the hypervisor to the VMs and vice versa. In most cases, CBSD will use the <code>bridge1</code> interface.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 id="4-1">4.1 Add Bridge Gateways</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>Note that these changes will not survive across reboots. I have not tested if adding a persistent entry for <code>bridge1</code> in <code>/etc/rc.conf</code> would work as expected with CBSD, as it manages the <code>bridge1</code> interface.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:embed {"url":"https://gist.github.com/kbruner/63d892a4922bb2da6c60c55a1fb610d7","type":"rich","providerNameSlug":"embed-handler"} --></p>
<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler">
<div class="wp-block-embed__wrapper">
https://gist.github.com/kbruner/63d892a4922bb2da6c60c55a1fb610d7
</div>
</figure>
<p><!-- /wp:embed --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 id="4-2">4.2 Configure NAT</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>We can reach our VM just fine from the host, but the VMs can't talk to the Internet because only the FreeBSD host can route to this <code>10.0.0.0/8</code> block. We will use <code><a href="https://www.freebsd.org/doc/handbook/firewalls-ipfw.html">ipfw</a></code> as a NAT (Network Address Translation) service. These steps will enable <code>ipfw</code> with open firewall rules and then configure the NAT. These changes will take effect immediately. The service and kernel settings will persist across reboots, but the <code>ipfw</code> firewall rules will not. See <a href="https://www.freebsd.org/doc/handbook/firewalls-ipfw.html">the <code>ipfw</code> chapter</a> about how to create and enable a firewall script.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Note that my host's physical interface is named <code>em0</code>. You may have to alter some commands if yours has a different name.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:embed {"url":"https://gist.github.com/kbruner/a6570bf7345f63353d2307e4f6acae77","type":"rich","providerNameSlug":"embed-handler"} --></p>
<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler">
<div class="wp-block-embed__wrapper">
https://gist.github.com/kbruner/a6570bf7345f63353d2307e4f6acae77
</div>
</figure>
<p><!-- /wp:embed --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 id="4-3">4.3 Configure Local DNS</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>We need a way to resolve our VM host names. We need to pick a private <code>.local</code> DNS domain, configure an authoritative server for the domain, and then set up a local caching server that knows about our domain but can also still resolve external addresses for us. We will follow <a rel="noreferrer noopener" href="https://blog.socruel.nu/freebsd/how-to-implement-unbound-and-nsd-on-freebsd.html" target="_blank">this <code>nsd</code>/<code>unbound</code> tutorial</a> closely.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>4.3.1 Enable <code>unbound</code> for recursive/caching DNS</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>FreeBSD has a caching (lookup-only) DNS service called <code><a href="https://www.freebsd.org/doc/handbook/network-dns.html">unbound</a></code> in the base system. It will use the configured nameservers for external address lookups and the local <code>nsd</code> service (configured next) for lookups to our private zone. Copy <code><a href="https://github.com/kbruner/freebernetes/blob/main/k3s/dns/unbound/unbound.conf">unbound.conf</a></code> and make any edits as necessary to IP addresses or your local zone name.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>You will also want to update the FreeBSD host's <code>/etc/resolv.conf</code> to add your local domain to the <code>search</code> list and add an entry for <code>nameserver 127.0.0.1</code>.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:embed {"url":"https://gist.github.com/kbruner/0b7032c60bc1e980e398e9ed761ebc3e","type":"rich","providerNameSlug":"embed-handler"} --></p>
<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler">
<div class="wp-block-embed__wrapper">
https://gist.github.com/kbruner/0b7032c60bc1e980e398e9ed761ebc3e
</div>
</figure>
<p><!-- /wp:embed --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>4.3.2 Configure the Authoritative DNS Service</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>We will use <code><a href="https://nlnetlabs.nl/projects/nsd/about/">nsd</a></code>, a lightweight, authoritative-only service, for our local zone. After copying the files, you can edit/rename the copied files before proceeding to make changes as necessary to match your local domain or IP addresses.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:embed {"url":"https://gist.github.com/kbruner/4c823a16a775138464977479c8756765","type":"rich","providerNameSlug":"embed-handler"} --></p>
<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler">
<div class="wp-block-embed__wrapper">
https://gist.github.com/kbruner/4c823a16a775138464977479c8756765
</div>
</figure>
<p><!-- /wp:embed --></p>
<p><!-- wp:paragraph --></p>
<p><a href="../6">Next -&gt;</a></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:nextpage --><br />
<!--nextpage--><br />
<!-- /wp:nextpage --></p>
<p><!-- wp:heading --></p>
<h2 id="part-5">Part 5: Create the Cluster</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:html --></p>
<li><a href="#5-1">5.1 Install Servers</a></li>
<li><a href="#5-2">5.2 Install Agents</a></li>
<li><a href="#5-3">5.3 Set Up Service Load Balancing</a></li>
<p><!-- /wp:html --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 id="5-1">5.1 Install Servers</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>We'll create the control plane by creating the cluster on <code>server-0</code>, then adding <code>server-1</code> and <code>server-2</code> to the cluster. </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>We want to load balance requests to the Kubernetes API endpoint across the three server VMs. For true high-availability, we would want to use a load balancer with liveness health checks. For this tutorial, though, we will just use a simple round-robin method using <code>ipfw</code> rules for a virtual IP address, <code>10.0.0.2</code>.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>We will use the virtual IP for the Kubernetes API endpoint as we build out the cluster. This method allows us to configure K3s to use that endpoint for connections to the API endpoint without hitting a host which has not yet been bootstrapped.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>We also have to add the virtual IP address to the primary interface on each server VM so it will accept traffic for the VIP. This change won't persist over reboots unless you add the second IP address to <code>/etc/netplan/50-cloud-init.yaml</code> on each server VM.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Note that the <code>ipfw</code> firewall rules we're adding will not persist across reboots. See <a href="https://www.freebsd.org/doc/handbook/firewalls-ipfw.html">the <code>ipfw</code> chapter</a> about how to create and enable a firewall script.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:embed {"url":"https://gist.github.com/kbruner/1ad917dc4d39dbe0821bcfb782c14c17","type":"rich","providerNameSlug":"embed-handler"} --></p>
<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler">
<div class="wp-block-embed__wrapper">
https://gist.github.com/kbruner/1ad917dc4d39dbe0821bcfb782c14c17
</div>
</figure>
<p><!-- /wp:embed --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 id="5-2">5.2 Install Agents</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:embed {"url":"https://gist.github.com/kbruner/dde0b5716aaa586d684f598827312ad9","type":"rich","providerNameSlug":"embed-handler"} --></p>
<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler">
<div class="wp-block-embed__wrapper">
https://gist.github.com/kbruner/dde0b5716aaa586d684f598827312ad9
</div>
</figure>
<p><!-- /wp:embed --></p>
<p><!-- wp:heading {"level":3} --></p>
<h3 id="5-3">5.3 Set Up Service Load Balancing</h3>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>Generally, if you want to expose a Kubernetes application endpoint on an IP address outside the cluster's network, you would create a <code><a href="https://kubernetes.io/docs/concepts/services-networking/service/">Service</a></code> object of type <code>LoadBalancer</code>. However, because load balancer options and implementations are unique for each cloud provider and self-hosted environment, Kubernetes expects you to have a controller running in your cluster to manage service load balancers. We have no such controller for our FreeBSD hypervisor, but we have a couple basic alternatives.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>5.3.1 Routing to <code>NodePort Services</code></h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>For <code>Services</code> of type <code>NodePort</code>, we can route directly to the <code>Service</code>'s virtual IP, which will be in our <code>10.2.0.0/16</code> service network block. Each service VIP is routeable by every node, so if we set up round-robin forwarding rules on the hypervisor's firewall, we should be able to reach <code>NodePort</code> endpoints.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Note that the <code>ipfw</code> firewall rules we're adding will not persist across reboots. See <a href="https://www.freebsd.org/doc/handbook/firewalls-ipfw.html">the <code>ipfw</code> chapter</a> about how to create and enable a firewall script.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:embed {"url":"https://gist.github.com/kbruner/2518f044108c0bdab14394c013022250","type":"rich","providerNameSlug":"embed-handler"} --></p>
<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler">
<div class="wp-block-embed__wrapper">
https://gist.github.com/kbruner/2518f044108c0bdab14394c013022250
</div>
</figure>
<p><!-- /wp:embed --></p>
<p><!-- wp:heading {"level":4} --></p>
<h4>5.3.1 K3s Service Load Balancer</h4>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>K3s has its own option for load balancer services. You can read <a href="https://rancher.com/docs/k3s/latest/en/networking/#service-load-balancer">the documentation</a> for details. The service IP address will share the IP address of a node in the cluster. We will see a demonstration in the next section, when we test our cluster.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Note that with the K3s service load balancer, you run the risk of being unable to create a <code>LoadBalancer</code>-type service because of a high risk of port collisions, which are not usually a problem with most Kubernetes <code>LoadBalancer</code> implementations.  </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><a href="../7">Next -&gt;</a></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:nextpage --><br />
<!--nextpage--><br />
<!-- /wp:nextpage --></p>
<p><!-- wp:heading --></p>
<h2 id="part-6">Part 6: Test the Cluster</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>We'll run the following tests:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list {"ordered":true} --></p>
<ol>
<li>Create <code>nginx</code> deployment</li>
<li>Port-forward to <code>nginx</code> pod</li>
<li>Check <code>nginx</code> pod's logs</li>
<li>Expose <code>nginx NodePort Service</code></li>
<li>Expose <code>nginx LoadBalancer Service</code> on port 8080</li>
<li>Test pod-to-pod connectivity</li>
</ol>
<p><!-- /wp:list --></p>
<p><!-- wp:embed {"url":"https://gist.github.com/kbruner/ddd7eb49ff38df546f3785d2e531ab43","type":"rich","providerNameSlug":"embed-handler"} --></p>
<figure class="wp-block-embed is-type-rich is-provider-embed-handler wp-block-embed-embed-handler">
<div class="wp-block-embed__wrapper">
https://gist.github.com/kbruner/ddd7eb49ff38df546f3785d2e531ab43
</div>
</figure>
<p><!-- /wp:embed --></p>
<p><!-- wp:paragraph --></p>
<p><a href="../8">Next -&gt;</a></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:nextpage --><br />
<!--nextpage--><br />
<!-- /wp:nextpage --></p>
<p><!-- wp:heading --></p>
<h2 id="part-7">Part 7: Clean Up</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:paragraph --></p>
<p>To clean up:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<li>Stop and remove the VMs
<ul>
<li><code>cbsd bstop agent-0</code> # etc</li>
<li><code>cbsd bremove agent-0</code> # etc</li>
</ul>
</li>
<li>Edit <code>/etc/rc.conf</code> to remove any settings that were added</li>
<li>Edit <code>/etc/sysctl.conf</code> to remove any settings that were added</li>
<li>Reboot</li>
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:separator {"opacity":"css"} --></p>
<hr class="wp-block-separator has-css-opacity" />
<!-- /wp:separator --></p>
<p><!-- wp:paragraph --></p>
<p>Please let me know if you have questions or suggestions either in the comments or <a href="https://twitter.com/fuzzyKB" target="_blank" rel="noreferrer noopener">on Twitter</a>.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:heading --></p>
<h2>Sources and References</h2>
<p><!-- /wp:heading --></p>
<p><!-- wp:list --></p>
<ul>
<li><a href="https://blog.socruel.nu/freebsd/how-to-implement-unbound-and-nsd-on-freebsd.html">https://blog.socruel.nu/freebsd/how-to-implement-unbound-and-nsd-on-freebsd.html</a></li>
<li><a href="https://cbsd.io/">https://cbsd.io/</a></li>
<li><a href="https://github.com/alexellis/k3sup/ ">https://github.com/alexellis/k3sup/</a></li>
<li><a href="https://k3s.io/ ">https://k3s.io/</a></li>
<li><a href="https://kubernetes.io/">https://kubernetes.io/</a></li>
<li><a href="https://kubernetes.io/docs/concepts/services-networking/service/ ">https://kubernetes.io/docs/concepts/services-networking/service/</a></li>
<li><a href="https://www.freebsd.org/doc/handbook/firewalls-ipfw.html">https://www.freebsd.org/doc/handbook/firewalls-ipfw.html</a></li>
<li><a href="https://www.freebsd.org/doc/handbook/network-bridging.html ">https://www.freebsd.org/doc/handbook/network-bridging.html</a></li>
<li><a href="https://www.freebsd.org/doc/handbook/ports.html">https://www.freebsd.org/doc/handbook/ports.html</a></li>
</ul>
<p><!-- /wp:list --></p>
